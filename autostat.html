<!DOCTYPE html>
<html class="mcss">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="midas.css">
    <script src="controls.js"></script>
    <script src="jquery.min.js"></script>
    <script src="midas.js"></script>
    <script src="mhttpd.js"></script>
    <title>AutoStat</title>
    <script>
        function setup(){
            // set table rows and sections

            // fpvs
            let equipments = ["PID_20KShield", "PID_100KShield",
                            "PID_TransLineTemp", "PID_Wall2Temp",
                            "PID_ECollar",
                            ];
            set_table_section("FPVs", equipments);

            // purifier heaters
            equipments = [  "PID_PUR_HE70K", "PID_PUR_ISO70K", "PID_PUR_HE20K",
                            "PID_PUR_ISO20K",
                        ];
            set_table_section("Purifier Heaters", equipments);

            // tail section heaters
            equipments = ["PID_HTR001", "PID_HTR003", "PID_HTR004", "PID_HTR005",
                        "PID_HTR006", "PID_HTR007", "PID_HTR008"
                        ];
            set_table_section("Tail Section Heaters", equipments);

            // notes and title changes
            document.getElementById("PID_HTR008_title").innerHTML = "PID_HTR008 (not working, perhaps because TS223 is not working?)";
        }

        var gStatusInflight = false;
        function statusPeriodicUpdate(){

            // don't make another request if the last request is still outstanding.
            if(gStatusInflight) return;
            gStatusInflight = true;

            mjsonrpc_send_request([
                    mjsonrpc_make_request("cm_exist",{"name":"fe_autostat"}),
                ]).then(function (rpc) {

                    // get all checkboxes
                    let checkboxes = document.getElementsByClassName("AutoEnable");

                    // Check the status of the autostat frontend
                    var prog_exist = rpc[0].result.status;

                    // fe running
                    if(prog_exist == 1){

                        // set banner
                        document.getElementById('updateStatus').innerHTML = "fe_autostat program is running";
                        document.getElementById('updateStatus').style.background = "#65f7ae";

                        // enable all checkboxes
                        for(let i=0; i<checkboxes.length; i++){
                            checkboxes[i].disabled = false;
                        }

                    // fe not running
                    }else{

                        // set banner
                        document.getElementById('updateStatus').innerHTML = "fe_autostat program NOT running";
                        document.getElementById('updateStatus').style.background = "#f58282";

                        // disable all checkboxes
                        for(let i=0; i<checkboxes.length; i++){
                            checkboxes[i].disabled = true;
                        }
                    }

                    gStatusInflight = false; // finished async routine
                }).catch(function(error) {
                    if (error.request) {
                        var s = mjsonrpc_decode_error(error);
                        console.log("mjsonrpc_error_alert: " + s);
                    } else {
                        console.log("mjsonroc_error_alert: " + error);
                    }
                });
        }

        function set_table_section(section, equipments){
            /*
                Fill in table rows.

                section: string, title of the section
                equipments: array of equipment names to populate with
            */

            const table = document.getElementById("table_body");

            // make section
            let row = table.insertRow();
            let cell = row.insertCell();
            cell.outerHTML = `<th colspan="5" class="mtableheader">${section}</th>`;

            // make header
            row = table.insertRow();
            let columns = ["Program", "Controlling", "Target", "Target Setpoint", "Enabled"];
            let width = ["200px", "200px", "200px", "70px", "70px"];

            for(let i=0; i<columns.length; i++){
                let cell = row.insertCell();
                cell.innerHTML = `<b>${columns[i]}</b>`;
                cell.style = `width: ${width[i]}; text-align: center;`;
            }

            // make cells
            for(let i=0; i<equipments.length; i++){
                row = table.insertRow();
                let equip = equipments[i];

                row.insertCell().innerHTML = `<a href="/Equipment/${equip}/Settings"><div id=${equip}_title>${equip}</div></a>`;
                row.insertCell().innerHTML = `<div name="modbvalue" data-odb-path="/Equipment/${equip}/Settings/control_pv" data-odb-editable="0" ></div>`;
                row.insertCell().innerHTML = `<div name="modbvalue" data-odb-path="/Equipment/${equip}/Settings/target_pv" data-odb-editable="0" ></div>`;
                row.insertCell().outerHTML = `<td style="text-align: center;"><div name="modbvalue" data-odb-path="/Equipment/${equip}/Settings/target_setpoint" data-odb-editable="1" ></div></td>`;
                row.insertCell().outerHTML = `<td style="text-align: center;"><input class="AutoEnable" type="checkbox" name="modbcheckbox" data-odb-path="/Equipment/${equip}/Settings/Enabled"></input></td>`;
            }
        }
    </script>
</head>

<body class="mcss" onload="setup();mhttpd_init('AutoStat');setInterval(statusPeriodicUpdate,3000);statusPeriodicUpdate()">

    <!-- header and side navigation will be filled in mhttpd_start -->
    <div id="mheader"></div>
    <div id="msidenav"></div>
    <div id="mmain">
    <div id="full_div" style="display:block">
        <section>
                <table class="mtable">

                    <!-- TABLE HEADER -->
                    <thead>
                        <tr style="height: 50px">
                            <th colspan="5" class="mtableheader"><h1>Enable AutoStat Control Loops</h1></th>
                        </tr>
                        <tr>
                            <td colspan="5" style="text-align: center"> <b><div id="updateStatus"></b></td>
                        </tr>
                    </thead>
                    <tbody id="table_body"></tbody>
                </table>
        </section>
        </div>
</body>
</html>
