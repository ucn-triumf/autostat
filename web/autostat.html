<!DOCTYPE html>
<html class="mcss">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="midas.css">
    <script src="controls.js"></script>
    <script src="jquery.min.js"></script>
    <script src="midas.js"></script>
    <script src="mhttpd.js"></script>
    <style>
        table {
            float: left;
            width: 50%;
        }
        button {
            width: 90%;
        }
    </style>
    <title>AutoStat</title>
    <script>
        function setup(){
            // set table rows and sections

            // PID ---------------------------------------------------------

            // fpvs
            set_pid_table_section("FPVs",
                             ["PID_20KShield", "PID_100KShield", "PID_TransLineTemp",
                              "PID_Wall2Temp", "PID_ECollar"]);

            // purifier heaters
            set_pid_table_section("Purifier Heaters",
                             ["PID_PUR_HE70K", "PID_PUR_ISO70K", "PID_PUR_HE20K",
                              "PID_PUR_ISO20K"]);

            // tail section heaters
            set_pid_table_section("Tail Section Heaters",
                             ["PID_HTR001", "PID_HTR003", "PID_HTR004",
                              "PID_HTR005", "PID_HTR006", "PID_HTR007",
                              "PID_HTR008"]);

            // notes and title changes
            // please leave the following line as an example of how to do this
            // document.getElementById("PID_HTR008_title").innerHTML = "PID_HTR008 (not working, unsure why)";


            // SCRIPTS ------------------------------------------------------
            set_script_table_section("Test",
                [["CryoScriptTester", 'This test has parameter temperature of <span class="ScriptInput" name="modbvalue" data-odb-path="/Equipment/CryoScriptTester/Settings/temperature_K" data-odb-editable="1"></span> K'],
                ["CryoScriptTester", 'A second line, now with a string "<span class="ScriptInput" name="modbvalue" data-odb-path="/Equipment/CryoScriptTester/Settings/test2" data-odb-editable="1"></span>" and a number: <span class="ScriptInput" name="modbvalue" data-odb-path="/Equipment/CryoScriptTester/Settings/test" data-odb-editable="1"></span>']]);

            setup_script_queue();
        }

        var gStatusPIDInflight = false;
        function update_pid_runstate(){

            // don't make another request if the last request is still outstanding.
            if(gStatusPIDInflight) return;
            gStatusPIDInflight = true;

            mjsonrpc_send_request([
                    mjsonrpc_make_request("cm_exist",{"name":"fe_autostat_pid"}),
                ]).then(function (rpc) {

                    // get all checkboxes
                    let checkboxes = document.getElementsByClassName("AutoEnable");

                    // Check the status of the autostat frontend
                    var prog_exist = rpc[0].result.status;

                    // fe running
                    if(prog_exist == 1){

                        // set banner
                        document.getElementById('updateStatus').innerHTML = "fe_autostat_pid program is running";
                        document.getElementById('updateStatus').style.background = "#65f7ae";

                        // enable all checkboxes
                        for(let i=0; i<checkboxes.length; i++){
                            checkboxes[i].disabled = false;
                        }

                    // fe not running
                    }else{

                        // set banner
                        document.getElementById('updateStatus').innerHTML = "fe_autostat_pid program is NOT running";
                        document.getElementById('updateStatus').style.background = "#f58282";

                        // disable all checkboxes
                        for(let i=0; i<checkboxes.length; i++){
                            checkboxes[i].disabled = true;
                        }
                    }

                    gStatusPIDInflight = false; // finished async routine
                }).catch(function(error) {
                    if (error.request) {
                        var s = mjsonrpc_decode_error(error);
                        console.log("mjsonrpc_error_alert: " + s);
                    } else {
                        console.log("mjsonroc_error_alert: " + error);
                    }
                });
        }

        var gStatusScrInflight = false;
        function update_scr_runstate(){

            // don't make another request if the last request is still outstanding.
            if(gStatusScrInflight) return;
            gStatusScrInflight = true;

            mjsonrpc_send_request([
                    mjsonrpc_make_request("cm_exist",{"name":"fe_autostat_script"}),
                ]).then(function (rpc) {

                    // get all input elements
                    let inputs = document.getElementsByClassName("ScriptInput");

                    // Check the status of the autostat frontend
                    var prog_exist = rpc[0].result.status;

                    // fe running
                    if(prog_exist == 1){

                        // set banner
                        document.getElementById('script_running').innerHTML = "fe_autostat_script program is running";
                        document.getElementById('script_running').style.background = "#65f7ae";

                        // enable all inputs
                        for(let i=0; i<inputs.length; i++){
                            inputs[i].disabled = false;
                        }

                    // fe not running
                    }else{

                        // set banner
                        document.getElementById('script_running').innerHTML = "fe_autostat_script program is NOT running";
                        document.getElementById('script_running').style.background = "#f58282";

                        // disable all inputs
                        for(let i=0; i<inputs.length; i++){
                            inputs[i].disabled = true;
                        }
                    }

                    gStatusScrInflight = false; // finished async routine
                }).catch(function(error) {
                    if (error.request) {
                        var s = mjsonrpc_decode_error(error);
                        console.log("mjsonrpc_error_alert: " + s);
                    } else {
                        console.log("mjsonroc_error_alert: " + error);
                    }
                });
        }

        function set_pid_table_section(section, equipments){
            /*
                Fill in table rows.

                section: string, title of the section
                equipments: array of equipment names to populate with
            */

            const table = document.getElementById("table_body");

            // make section
            let row = table.insertRow();
            let cell = row.insertCell();
            cell.outerHTML = `<th colspan="5" class="mtableheader">${section}</th>`;

            // make header
            row = table.insertRow();
            let columns = ["Program", "Controlling", "Target", "Target Setpoint", "Enabled"];
            let width = ["200px", "200px", "200px", "70px", "70px"];

            for(let i=0; i<columns.length; i++){
                let cell = row.insertCell();
                cell.innerHTML = `<b>${columns[i]}</b>`;
                cell.style = `width: ${width[i]}; text-align: center;`;
            }

            // make cells
            for(let i=0; i<equipments.length; i++){
                row = table.insertRow();
                let equip = equipments[i];

                row.insertCell().innerHTML = `<a href="/Equipment/${equip}/Settings"><div id=${equip}_title>${equip}</div></a>`;
                row.insertCell().innerHTML = `<div name="modbvalue" data-odb-path="/Equipment/${equip}/Settings/control_pv" data-odb-editable="0" ></div>`;
                row.insertCell().innerHTML = `<div name="modbvalue" data-odb-path="/Equipment/${equip}/Settings/target_pv" data-odb-editable="0" ></div>`;
                row.insertCell().outerHTML = `<td style="text-align: center;"><div name="modbvalue" data-odb-path="/Equipment/${equip}/Settings/target_setpoint" data-odb-editable="1" ></div></td>`;
                row.insertCell().outerHTML = `<td style="text-align: center;"><input class="AutoEnable" type="checkbox" name="modbcheckbox" data-odb-path="/Equipment/${equip}/Settings/Enabled"></input></td>`;
            }
        }

        function set_script_table_section(section, equipments){
            /*
                Fill in table rows.

                section: string, title of the section
                equipments: array of equipment names to populate with
            */

            const table = document.getElementById("scripts_body");

            // make section
            let row = table.insertRow();
            let cell = row.insertCell();
            cell.outerHTML = `<th colspan="5" class="mtableheader">${section}</th>`;

            // make header
            row = table.insertRow();
            let columns = ["Script Name", "Inputs", "Queue"];
            let width = ["200px", "500px", "70px"];

            for(let i=0; i<columns.length; i++){
                let cell = row.insertCell();
                cell.innerHTML = `<b>${columns[i]}</b>`;
                cell.style = `width: ${width[i]}; text-align: center;`;
            }

            // make cells
            for(let i=0; i<equipments.length; i++){
                row = table.insertRow();
                let equip = equipments[i][0];
                let desc = equipments[i][1];

                row.insertCell().innerHTML = `<a href="/Equipment/${equip}/Settings"><div id=${equip}_title>${equip}</div></a>`;
                row.insertCell().innerHTML = desc;
                row.insertCell().outerHTML = `<td align="center"><button class="ScriptInput" id="add_${equip}">Add</button></td>`;
            }
        }

        function setup_script_queue(){
            const table = document.getElementById("scripts_body");

            // make section
            let row = table.insertRow();
            let cell = row.insertCell();
            cell.outerHTML = `<th colspan="5" class="mtableheader">Queue</th>`;

            row = table.insertRow();
            cell = row.insertCell();
            cell.outerHTML = '<td align="center"><button class="ScriptInput" id="runscript">Run Queued Scripts</button></td>';
            cell = row.insertCell();
            cell.outerHTML = '<td align="center"><button class="ScriptInput" id="stopscript">Stop Execution</button></td>';
            cell = row.insertCell();
            cell.outerHTML = '<td align="center"><button class="ScriptInput" id="clearscript">Clear All</button></td>';
        }
    </script>
</head>

<body class="mcss" onload="setup();mhttpd_init('AutoStat');setInterval(update_pid_runstate,3000);update_pid_runstate();setInterval(update_scr_runstate,3000);update_scr_runstate();">

    <!-- header and side navigation will be filled in mhttpd_start -->
    <div id="mheader"></div>
    <div id="msidenav"></div>
    <div id="mmain">
    <div id="full_div">
        <section>
            <!-- PID Table -->
            <table class="mtable">
                <thead>
                    <tr style="height: 50px">
                        <th colspan="5" class="mtableheader"><h1>PID Control Loops</h1></th>
                    </tr>
                    <tr><td colspan="5" style="text-align: center"> <b><div id="updateStatus"></b></td></tr>
                </thead>
                <tbody id="table_body"></tbody>
            </table>

            <!-- Scripts Table -->
            <table class="mtable">
                <thead>
                    <tr style="height: 50px">
                        <th colspan="5" class="mtableheader"><h1>Scripts [THIS TABLE UNDER DEVELOPMENT]</h1></th>
                    </tr>
                    <tr><td colspan="5" style="text-align: center"> <div id="script_running"> </div></td></tr>
                </thead>
                <tbody id="scripts_body"></tbody>
            </table>
        </section>
    </div>
</body>
</html>
